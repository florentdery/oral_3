---
title: "Les vaches,<br>les amphibiens<br>et vous"
author: "Équipe 5 - Florent Déry, Morgane Le Goff, Myriam Trottier-Paquet"
date: "`r Sys.Date()`"
output:
  ioslides_presentation:
    widescreen: true
    smaller: true
editor_options: 
  chunk_output_type: console
---

<style>
pre {
    line-height: 1.2em;
    font-size: 10px;
}
</style>
## Contexte

Choix de projet = Effets des pâturages sur l'abondance et la diversité des amphibiens.

Invertebrés vs sensibilité / eutrophisation
Écrevisses vs sensibilité / eutrophisation
Poisson ?? 

## Objectif et question de recherche (étape 1)

Vérifier l'impact du pâturage par le bétail (vaches) sur les communautés d'amphibiens. 

## Hypothèses et prédictions (étape 2) | sous-titre
### sous titre ???

La présence et l'intensité d'M'utilisation du bétail modifient les conditions physico-chimiques des étangs, et ainsi l'abondance des invertébrés, poissons et écrevisses, ce qui détermine la composition des communautés amphibiennes. 


Prédictions: 
- Les conditions physico-chimiques sont différentes entre les étangs cloturés vs non-cloturés. 
  - Les vaches seront corrélées positivement aux nitrites
  - Les vaches seront corrélées positivement à la *temperature*?
  - Les vaches seront corrélées positivement à la conductivité
  - Les vaches seront corrélées négativement au pH
  - Les vaches seront corrélées négativement à l'O^2

## Variables du système (étape 3)

- Modèle conceptuel?
Voici le jeu de données : 

```{r load_dat, echo=F, warnings=F, message=F}
require(tidyverse)
dat=read.delim("data/jeu_ecologique.txt") %>% 
  mutate(etang=as.factor(as.character(etang)),
         cloture=factor(cloture)) %>% 
  rename(vache_std=vache) %>% 
  arrange(aire) 

glimpse(dat)
summary(dat)

```

## Rôle, type et distribution des variables (étape 4)
Jettons un coup d'oeil premièrement à la variable dépendante, représentée par une matrice d'abondance de la communauté amphibienne. Les colonnes représentent les espèces, et les lignes représentent les sites. 

```{r step_4_quick_look_to_Ys, echo=T, warnings=F, message=F}
amphi<-dat %>% 
  select(etang,A_Gr:N_Vi) %>% 
  column_to_rownames("etang")
# Étendue
range(amphi)
# Nombre de zéros, puis proportion de zéros dans la communauté
sum(amphi==0) ; sum(amphi==0)/(nrow(amphi)*ncol(amphi))
```
Les valeurs d'abondance relative sont entre 0 et 0.86. 
Les zéros (absences) composent 70.5% de la matrice. Les données d'abondance ont été standardisées par unité d'effort et par abondance totale pour chaque espèce. 

## Étape 4 - distribution des Ys
```{r distribution_ys,  echo=F, warnings=F, message=F, fig.align="center", fig.dim=c(10,4.3) }
amphi %>% 
  pivot_longer(1:9,names_to = "espece", values_to = "prop") %>% 
  mutate(lng_nm=case_when(espece=="A_Gr"~ "Acris gryllus",
                          espece=="G_Ca"~ "Gastrophryne carolinensis",
                          espece=="S_La"~ "Siren lacertina",
                          espece=="H_Ci"~ "Hyla cinerea",
                          espece=="H_Fe"~ "Hyla Femoralis",
                          espece=="H_Sq"~ "Hyla squirella",
                          espece=="L_Gr"~ "Lithobates grylio",
                          espece=="L_Sp"~ "Lithobates sphenocephalus",
                          espece=="N_Vi"~ "Notophthalmus viridescens")) %>% 
ggplot(aes(prop))+
  geom_histogram()+
  geom_density()+
  facet_wrap(~lng_nm, scales="free_y")+
  theme_bw()
```

## Étape 4 - Variables indépendantes X
La variable indépendante "cloture" est une variable catégorique à 2 facteurs (Yes, No). 
La variable "Intensité d'utilisation de l'étang par le bétail" est une variable numérique continue dont la distribution [min ; max = 0 ; 0.6] est biaisée à gauche. 

```{r distribution_xs,  echo=F, warnings=F, message=F, fig.align="center", fig.dim=c(10,4) }
p1= ggplot(dat, aes(cloture, fill=cloture))+
  geom_bar()+
  xlab("Étang clôturé ou non?")+
  ylab("Nombre d'étangs")+
  scale_fill_manual(values=c("steelblue4", "darkgoldenrod2"))+
  theme_bw()

p2=ggplot(dat, aes(vache_std))+  
geom_histogram(aes(fill=cloture))+
  geom_density()+
  xlab("Nombre de fèces standardisé")+
  ylab("Nombre d'étangs")+
  scale_fill_manual(values=c("steelblue4", "darkgoldenrod2"))+
  theme_bw()+
  theme(legend.position = c(0.8, 0.8))

require(patchwork)

p1 + p2 + plot_layout(ncol=2, widths=c(0.33, .67))
```
5 étangs sont clôturés, 35 étangs ne l'étaient pas. Parmi les étangs non-cloturés, 3 étangs ne semblent pas avoir été utilisés par les vaches (pas de fèces)

## Étape 4 - Covariables | Caractéristiques physico-chimiques -> non-standardisées
- Conductivité: numérique continue, distribution normale
- Nitrates: numérique continue, distribution déviée à gauche
- Température (Celcius): numérique continue, distribution déviée à gauche
  - Quelques valeurs extrèmes

```{r distribution_covariables_chim_a,  echo=F, warnings=F, message=F, fig.align="center", fig.dim=c(8,4) }
par(mfrow=c(1,3))
hist(dat$conductivite,
     main="Conductivité",
     xlab="Conductivité",
     col="cornflowerblue")
hist(dat$nitrates,
     main="Nitrates",
     xlab="Nitrates",
     col="cornflowerblue")
hist(dat$temperature,
     main="Température",
     xlab="Température en degré C",
     col="cornflowerblue")
range(dat$pH)
```
## Étape 4 - Covariables | Caractéristiques physico-chimiques

- Oxygène: numérique continue, distribution normale
  - Il y a des valeurs négatives!!!  
- pH: numérique continue, distribution déviée à gauche
  - Des étangs sont plus acides que du jus de citron, et presqu'aussi basiques que de l'eau de Javel! 
```{r distribution_covariables_chim_b,  echo=F, warnings=F, message=F, fig.align="center", fig.dim=c(10,4.3) }
par(mfrow=c(1,2))
hist(dat$oxygene,
     main="Oxygène",
     xlab="Oxygène dissous",
     col="cornflowerblue")
hist(dat$pH,
     main="pH",
     xlab="pH",
     col="cornflowerblue")
```

## Étape 4 - Covariables | Caractéristiques topographiques
- Profondeur (cm): numérique continue, distribution normale
- Aire (m^2): numérique continue, distribution *relativement* normale

```{r distribution_covariables_topo,  echo=F, warnings=F, message=F, fig.align="center", fig.dim=c(10,4.3) }
par(mfrow=c(1,2))
hist(dat$profondeur,
     main="Profondeur",
     xlab="Profondeur en cm",
     col="cornflowerblue")
hist(dat$aire,
     main="Aire",
     xlab="Aire en m^2",
     col="cornflowerblue")
```

## Étape 4 - Covariables | Facteurs biotiques

- Invertébrés: numérique continue, distribution déviée à gauche
- Écrevisses: numérique continue, distribution déviée à gauche avec beaucoup de zéros
- Poissons: numérique continue, distribution avec beaucoup de zéros

```{r distribution_covariables_biotiques,  echo=F, warnings=F, message=F, fig.align="center", fig.dim=c(8,4) }
par(mfrow=c(1,3))
hist(dat$invertebres,
     main="Invertébrés",
     xlab="Abondance d'invertébrés prédateurs",
     ylab="Nombre d'étangs",
     col="cornflowerblue")
hist(dat$ecrevisses,
     main="Écrevisses",
     xlab="Abondance d'écrevisses",
     ylab="Nombre d'étangs",
     col="cornflowerblue")
hist(dat$poissons,
     main="Poissons",
     xlab="Abondance de poissons",
     ylab="Nombre d'étangs",
     col="cornflowerblue")

```


## Interactions potentielles à tester (étape 5)

Aucune. La question initiale parle plus d'objectifs specifiques en termes d'effets fixes (Clôturé. vs pas Clôturé, ou encore l'effet de l'intensité d'utilisation des vaches). On pose des questions en termes d'effets seuls - pas en interaction. On demande toutefois de prendre en compte les caractéristiques physico-chimiques et biotiques.  

```{r boff_interaction, echo = F}
# dat %>% 
#   mutate(prof_cat=factor(
#     case_when(
#       profondeur < 181 ~ "very_shallow", 
#       profondeur %in% c(181:242)~ "shallow",
#       profondeur %in% c(243:330)~ "medium",
#       profondeur %in% c(331:460)~ "deep",
#       profondeur > 460 ~ "very_deep"    
#     ), levels= c("very_shallow", 
#                  "shallow",
#                  "medium",
#                  "deep",
#                  "very_deep")))%>% 
#   pivot_longer(A_Gr:N_Vi, names_to = "espece", values_to = "prop") %>% 
#   pivot_longer(conductivite:pH, names_to = "parametre", values_to = "mesure") %>% 
#   ggplot()+
#   geom_point(aes(x= mesure, y= prop, color=espece)) +
#   facet_grid(vars(cloture), vars(prof_cat), scales= "free_x", space="free_x")+
#   ylab("Proportion par site")+
#   xlab("Mesure du paramètre")
```

## Exploration des données (étape 6)

## 6.1 - Données aberrantes en X 
- Les valeurs de vache_std sont entre 0 et 0.575
- Il ne semble pas y avoir de données aberrantes, mais 3 étangs non-clôturés ne semblent pas avoir été visités par les vaches. 

```{r abberent_Xs_vache, echo=F, warnings=F, message=F, fig.align="center", fig.dim=c(8,4) }
range(dat$vache_std) 
p3=ggplot(dat)+
  geom_histogram(aes(vache_std))+
  xlab("")+
  ylab("Fréquence")+
    theme_bw()
p4=ggplot(dat)+
  geom_point(aes(y=rownames(dat), x=vache_std))+
  xlab("")+
  ylab("Index (No de ligne)")+
    theme_bw()
p5=ggplot(dat)+
  geom_boxplot(aes(x=vache_std))+
  xlab("")+
  ylab("")+
  theme_bw()+
  theme(axis.line.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())
require(cowplot)
p6=plot_grid(p3,p5, nrow=2, rel_heights = c(3.5, 1))
plot_grid(p6,p4, ncol=2)+
  labs(caption="Nombre de fèces standardisé")
```

## 6.1 - Données aberrantes en X 
- O2: Il y a des valeurs négatives!!!  
- pH: Des étangs sont plus acides que du jus de citron, et presqu'aussi basiques que de l'eau de Javel! 

```{r abberent_Xs_physico, echo=F, warnings=F, message=F, fig.align="center", fig.dim=c(8,4) }
Chimie<-dat[ , c(5:9)]
l1 <- function() {
  par(
    mar=c(1,1,1,1),
    mfrow=c(1,5)
  )
for(i in 1:ncol(Chimie)) {
  hist(Chimie[,i], main=names(Chimie)[i], breaks=30)
}
}

l2 <- function() {
  par(
    mar=c(1,1,1,1),
    mfrow=c(1,5)
  )
  for(i in 1:ncol(Chimie)) {
    boxplot(Chimie[,i],horizontal = T, main=NULL)
  }
}
library(gridGraphics); library(cowplot)
plot_grid(ggdraw(l1) , ggdraw(l2), ncol=1, rel_heights = c(.8, .2))

```

## 6.1 - Données aberrantes en X 

Il ne semble pas particulièrement y avoir de données aberrantes en ce qui concerne la topographie des étangs

```{r aberrant_Xs_topo, echo=F, warnings=F, message=F, fig.align="center", fig.dim=c(8,4) }
Top<-dat[ , c(4, 10)]

l1=function()  {
  par(
  mfrow=c(1,2),
    mar=c(1,1,1,1)
  )
for(i in 1:ncol(Top)) {
  hist(Top[,i], main=names(Top)[i], breaks=30)
}
}
l2=function()  {
  par(
  mfrow=c(1,2),
    mar=c(1,1,1,1)
  )
for(i in 1:ncol(Top)) {
  boxplot(Top[,i], main=NULL, horizontal=T)
}
}

plot_grid(ggdraw(l1) , ggdraw(l2), ncol=1, rel_heights = c(.8, .2))
```

## 6.1 - Données aberrantes en X 

En ce qui concerne les poissons et les écrevisses, i8l semble y avoir beaucoup de zéros. Il faudra peut-être transformer (e.g. log) les variables poissons et écrevisses. Les écrevisses étant des prédateurs des grenouilles (tétards), on pourrait peut-être travailler en absence-présence d'écrevisses dans nos analyses, si cette variable est problématique.  

```{r aberrant_Xs_biotiques, echo=F, warnings=F, message=F, fig.align="center", fig.dim=c(8,4) }
living<-dat[ , c("invertebres", "poissons", "ecrevisses")]

l1=function () {
par(
  mfrow=c(1,3),
    mar=c(1,1,1,1)
  )
for(i in 1:ncol(living)) {
  hist(living[,i], main=names(living)[i], breaks=30)
} 
}


l2=function () {
par(
  mfrow=c(1,3),
    mar=c(1,1,1,1)
  )
for(i in 1:ncol(living)) {
  boxplot(living[,i], main=NULL, horizontal=T)
}
}

plot_grid(ggdraw(l1) , ggdraw(l2), ncol=1, rel_heights = c(.8, .2))
```

## 6.1 - Données aberrantes en Y

On a déjà jetté un coup d'oeil à la distribution des abondances relatives d'amphibien à l'étape 4. Le voici en rappel avec des boxplots. 

```{r aberrant_Ys, echo=F, warnings=F, message=F, fig.align="center", fig.dim=c(10,5) }
amphi<-dat %>% 
  select(etang,A_Gr:N_Vi) %>% 
  column_to_rownames("etang") 


l1=function () {
par(
  mfrow=c(1,3),
    mar=c(1,1,1,1)
  )
for(i in 1:3) {
  hist(amphi[,i], main=names(amphi)[i], breaks=30)
}
}

l2=function () {
par(
  mfrow=c(1,3),
    mar=c(2,1,1,1)
  )
for(i in 1:3) {
  boxplot(amphi[,i], main=NULL, horizontal=T)
}
}

line1=plot_grid(ggdraw(l1) , ggdraw(l2), ncol=1, rel_heights = c(.7 , .3))
l3=function () {
par(
  mfrow=c(1,3),
    mar=c(1,1,1,1)
  )
for(i in 4:6) {
  hist(amphi[,i], main=names(amphi)[i], breaks=30)
}
}

l4=function () {
par(
  mfrow=c(1,3),
    mar=c(2,1,1,1)
  )
for(i in 4:6) {
  boxplot(amphi[,i], main=NULL, horizontal=T)
}
}

line2=plot_grid(ggdraw(l3) , ggdraw(l4), ncol=1, rel_heights = c(.7 , .3))

l5=function () {
par(
  mfrow=c(1,3),
    mar=c(1,1,1,1)
  )
for(i in 7:9) {
  hist(amphi[,i], main=names(amphi)[i], breaks=30)
}
}

l6=function () {
par(
  mfrow=c(1,3),
    mar=c(2,1,1,1)
  )
for(i in 7:9) {
  boxplot(amphi[,i], main=NULL, horizontal=T)
}
}

line3=plot_grid(ggdraw(l5) , ggdraw(l6), ncol=1, rel_heights = c(.7 , .3))
plot_grid(line1, 
          line2,
          line3, ncol=1)

rm(l1,l2, l3, l4, l5,l6,
   line1, 
   line2, 
   line3)

```

## 6.1 - Données aberrantes en Y

On peut toutefois inspecter le compte d'espèces à chaque site (convertir les abondances relatives en 0-1 pour chaque site). On peut aussi jetter un coup d'oeil à la richesse spécifique. 

```{r amphi_barplot, echo=F, warnings=F, message=F, fig.align="center", fig.dim=c(8,3)}
amphi<-dat %>% 
  select(etang,A_Gr:N_Vi) %>% 
  column_to_rownames("etang") %>% 
  vegan::decostand(amphi, method = "pa") 

tmp=table(rowSums(amphi)) %>%
data.frame()
colnames(tmp) =  c("especes_presentes", "nombre_de_sites")

plot_grid(
  ggplot()+
    geom_col(aes(y=sort(colSums(amphi)),
                 x=factor(names(sort(colSums(amphi))), 
                          levels=names(sort(colSums(amphi))))
    )
    )+ 
    xlab("Espèce")+
    ylab("Nombre de présences\n(tous les sites confondus)")+
    theme_classic(),
  

  ggplot(tmp)+
    geom_col(aes(especes_presentes,nombre_de_sites))+
    xlab("Richesse spécifique à chaque site")+
    scale_y_continuous("Nombre de sites", 
                       breaks=seq(0, 12, 2), 
                       limits=c(0,12.1))+
    theme_classic()
)

```

## 6.2 - Homogénéité de la variance et normalité des Ys

Dans notre cas, on ne s'attend pas à ce que la variance des Ys soit homogène (on ne fait pas des modèles linéaires où les résidus devraient être homogènes, etc.); qui plus est, ce n'est pas une supposition à respecter dans le cadre d'une analyse multivariée...

Dans notre cas, on ne s'attend pas à ce que la variance des Ys soit Normale non plus. 

## 6.4 - Problèmes de 0 dans les Y

Comme on a vu plus tôt à l'étape 4 les zéros (absences) composent 70.5% de la matrice. Il se pourrait d'ailleurs que la faible présence de certaines espèces (H_Fe, N_Vi et A_GR) pose des problèmes pour l'analyse visée. 


## 6.5 - Collinéarité des X
Premièrement avec les étangs non cloturés: 
```{r, echo=F, message=F, warnings=F, fig.width=10, fig.height=5.3}
dat %>% 
  subset(cloture=="No" & vache_std>0) %>% 
  select(vache_std:poissons) %>%
  relocate(aire, .after = profondeur) %>% 
  psych::pairs.panels()

```

## 6.5 - Collinéarité des X
Maintenant avec les étangs non cloturés, sans la variables vache.
```{r, echo=F, message=F, warnings=F, fig.width=10, fig.height=5.3}
dat %>% 
    subset(cloture=="Yes" | vache_std==0) %>% 
  select(profondeur:poissons) %>%
  relocate(aire, .after = profondeur) %>% 
  psych::pairs.panels()

dat %>% 
    # subset(cloture=="Yes" | vache_std==0) %>% 
  select(vache_std:poissons) %>%
  relocate(aire, .after = profondeur) %>% 
  psych::pairs.panels()

```


## 6.5 - Collinéarité des X
Variable cloture vs. variables *physico-chimiques*

```{r, echo=F, message=F, warnings=F, fig.width=7, fig.height=4.3, fig.align="center"}
dat %>% 
  select(cloture, conductivite:pH) %>% 
  pivot_longer(conductivite:pH, names_to = "parametre", values_to = "mesure") %>% 
  ggplot(aes(y= mesure, x=cloture )) +
  geom_boxplot(outlier.shape = NA)+
  geom_jitter(height=0, width=.1)+
  facet_wrap(~parametre, scales = "free_y")+
  theme_bw()

```

## 6.5 - Collinéarité des X
Variable cloture vs. variables *topographiques*

```{r, echo=F, message=F, warnings=F, fig.width=7, fig.height=4.3, fig.align="center"}
dat %>% 
  select(cloture, profondeur, aire) %>% 
  pivot_longer(profondeur:aire, names_to = "caracteristique", values_to = "mesure") %>% 
  ggplot(aes(y= mesure, x=cloture )) +
  geom_boxplot(outlier.shape = NA)+
  geom_jitter(height=0, width=.1)+
  facet_wrap(~caracteristique, scales = "free_y")+
  theme_bw()

```

## 6.5 - Collinéarité des X
Variable clôture vs. variables *biotiques*

```{r, echo=F, message=F, warnings=F, fig.width=7, fig.height=4.3, fig.align="center"}
dat %>% 
  select(cloture, invertebres:poissons) %>% 
  pivot_longer(invertebres:poissons, names_to = "taxon", values_to = "compte") %>% 
  ggplot(aes(y= compte, x=cloture )) +
  geom_boxplot(outlier.shape = NA)+
  geom_jitter(height=0, width=.1)+
  facet_wrap(~taxon, scales = "free_y")+
  theme_bw()

```

## 6.6 - Liens X et Y
Abondances relatives en fonction des paramètres physico-chimiques
```{r, echo=F, message=F, warnings=F, fig.width=7, fig.height=4.3, fig.align="center"}

pal=paletteer::paletteer_d("colorBlindness::paletteMartin") %>%  sample(9)

dat%>% 
  pivot_longer(A_Gr:N_Vi, names_to = "espece", values_to = "prop") %>% 
  pivot_longer(conductivite:pH, names_to = "parametre", values_to = "mesure") %>% 
  ggplot(aes(x= mesure, y= prop))+
  geom_point(aes(color=espece), size=2) +
    geom_smooth()+
   scale_color_manual(values=pal)+
 facet_wrap(~parametre, scales= "free_x")+
  ylab("Proportion par site")+
  xlab("Mesure du paramètre")+
  theme_bw()


 # %>% 
 #  mutate(prof_cat=factor(
 #    case_when(
 #      profondeur < 181 ~ "very_shallow", 
 #      profondeur %in% c(181:242)~ "shallow",
 #      profondeur %in% c(243:330)~ "medium",
 #      profondeur %in% c(331:460)~ "deep",
 #      profondeur > 460 ~ "very_deep"    
 #    ), levels= c("very_shallow", 
 #                 "shallow",
 #                 "medium",
 #                 "deep",
 #                 "very_deep")))
```

## 6.6 - Liens X et Y
Abondances relatives en fonction des caractéristiques topographiques

```{r, echo=F, message=F, warnings=F, fig.width=7, fig.height=4.3, fig.align="center"}

dat%>% 
  pivot_longer(A_Gr:N_Vi, names_to = "espece", values_to = "prop") %>% 
  select(prop, profondeur, aire, espece) %>% 
  pivot_longer(profondeur:aire, names_to = "caracteristique", values_to = "mesure") %>% 
  ggplot(aes(x= mesure, y= prop))+
  geom_point(aes(color=espece), size=2) +
    geom_smooth()+
   scale_color_manual(values=pal)+
 facet_wrap(~caracteristique, scales= "free_x")+
  ylab("Proportion par site")+
  xlab("Mesure du paramètre")+
  theme_bw()

```

## 6.6 - Liens X et Y
Abondances relatives en fonction des facteurs biotiques

```{r, echo=F, message=F, warnings=F, fig.width=10, fig.height=4.3, fig.align="center"}
dat%>% 
  pivot_longer(A_Gr:N_Vi, names_to = "espece", values_to = "prop") %>% 
  pivot_longer(invertebres:poissons, names_to = "facteur_biotique", values_to = "compte") %>% 
  ggplot(aes(x= compte, y= prop))+
  geom_point(aes(color=espece), size=2) +
    geom_smooth()+
   scale_color_manual(values=pal)+
 facet_wrap(~facteur_biotique, scales= "free_x")+
  ylab("Proportion par site")+
  xlab("Mesure du paramètre")+
  theme_bw()

```

## 6.6 - Liens X et Y
Abondances relatives en fonction de l'intensité des vaches et de la présence de cloture

```{r, echo=F, message=F, warnings=F, fig.width=10, fig.height=4.3, fig.align="center"}
p1=dat%>% 
  pivot_longer(A_Gr:N_Vi, names_to = "espece", values_to = "prop") %>% 
  ggplot(aes(x= cloture, y= prop))+
  geom_boxplot(outlier.shape = NA)+
  geom_jitter(aes(color=espece),height=0, width=.1)+
   scale_color_manual(values=pal)+
  ylab("Proportion par site")+
  xlab("Cloturé?")+
  theme_bw()+
  theme(legend.position = "none")

p2= dat%>% 
  pivot_longer(A_Gr:N_Vi, names_to = "espece", values_to = "prop") %>% 
  ggplot(aes(x= vache_std, y= prop))+
  geom_point(aes(color=espece), size=2) +
    geom_smooth()+
   scale_color_manual(values=pal)+
  ylab("Proportion par site")+
  xlab("Intensité d'utilisation par les vaches")+
  theme_bw()

require(patchwork)
p1+p2+plot_layout(ncol=2, guides = "collect")
```

## 6.7 - Indépendance des Y

Richesse spécifique à chaque site

```{r, echo=F, message=F, warnings=F, fig.width=10, fig.height=4.3, fig.align="center"}
# Richesse spécifique vs sites

sit.pres <- apply(amphi > 0, 1, sum)

sit.pres= data.frame(sit.pres) %>% 
  rownames_to_column(var = "etang") %>% 
  inner_join(., dat[, c("etang", "profondeur","aire")]) %>% 
  rename(richesse= sit.pres)

require(ggplot2)

plot_grid(
ggplot(sit.pres)+
  #geom_point( aes(x=etang, y=richesse))+
  geom_step(aes(x=etang, y=richesse, group=1))+
  xlab("") +
  scale_y_continuous("Richesse spécifique",
                     breaks= 1:6) +
    ggtitle("Ordre dans les données")+
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90)),

sit.pres %>% 
  mutate(etang=factor(etang, levels=etang[order(.$profondeur)], ordered = T)) %>% 
ggplot()+
  #geom_point( aes(x=etang, y=richesse))+
  geom_step(aes(x=factor(etang), y=richesse, group=1))+
  xlab("Site") +
  scale_y_continuous("",
                     breaks= 1:6) +
  ggtitle("Peu profond ---> très creux")+
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90)),

sit.pres %>% 
  mutate(etang=factor(etang, levels=etang[order(.$aire)], ordered = T)) %>% 
ggplot()+
  #geom_point( aes(x=etang, y=richesse))+
  geom_step(aes(x=factor(etang), y=richesse, group=1))+
  xlab("") +
  scale_y_continuous("",
                     breaks= 1:6) +
  ggtitle("Moins gros ---> plus gros")+
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90)),
ncol=3)
```

## 6.8 - Collinéarité des Y

```{r, echo=F, message=F, warnings=F, fig.width=10, fig.height=4.3, fig.align="center"}
dat%>% 
  select(A_Gr:N_Vi) %>% 
  psych::pairs.panels()
```

## Faits saillants de l'exploration des données (étape 6):
- Les données d'abondance ont été standardisées par unité d'effort et par abondance totale pour chaque espèce. 
  - Les variables Y sont donc numériques continues vont de 0 à 0,86. La somme pour chaque espèce (colonne) est égale à 1. 
  - Près de 71% des données de la matrice d'abondance sont égales à 0.
- Certaines variables indépendantes semblent avoir des mesures erronnées, surtout pour l'oxygène, le pH et quelques des valeurs extrèmes de temperature. 
- Certaines variables pourraient bénéficier de transformation, particulièrement, la température, les poissons et les écrevisses.
- Les variables physico-chimiques devront être standardisées
- Les étangs plus creux et plus grands semblent avoir une richesse spécifique supérieure. La topographie des étangs pourrait influencer d'autres facteurs physico-chimiques, et donc l'aire et la profondeur devraient être considérés comme des covariables. 

##Étape 7. Choix de l'analyse

Nous avons décidé d'utiliser une analyse de redondance (RDA) partielle pour analyser comment la présence de clôture, l'utlisation des étangs par les vaches et les variables physico-chimiques en plus des facteurs biotiques font varier la communauté d'amphibiens, en prennant en compte l'effet de l'aire et de la profondeur des étangs comme co-variables.

Les données d'abondances sont loins d'être *Gaussienne*. Les RDAs sont des tests non-paramétriques, donc elles conviennent très bien aux données d'abondance que nous avons. À l'inverse, une MANOVA exige une distribution normalke multivariée. 

On a aussi décidé de faire une RDA partielle car on a des covariables (profondeur et aire) qui ne nous intéressent pas mais qui vont influencer les relations entre les autres variables. 

La RDA est un test statistique basé sur des permutations, ce qui nous permet d'étudier le lien entre une matrice de variables réponse et une matrice de variables expplicative. Les analyses non-contraintes (p. ex. une PCA) sont seulement descriptives: on ne test pas des liens de cause à effet.

### Étape 7. Choix de transformation de la matrice d'abondance: 

Lorsque plusieurs sites partagent la présence d'une espèce, nous savons que ces sites se ressemblent entre eux, (ils partagent les conditions nécessaires à la présence de cette espèce). Par contre, lorsque que plusieurs sites partagent l'absence d'une espèce, nous ne pouvons pas savoir si ces zéros sont dus aux même facteurs (absence réelle ou simplement pas été échantillonnée. Par conséquent, nous ne pouvons pas conclure qu'ils sont aussi ressemblants que s'ils partageaient la présence d'une espèce. 

Il est donc nécessaire de transformer les données à l'aide d'une mesure de **dissimilarité asymétrique** (pour donner davantage de poids à la présence qu'à l'absence de l'espèce). Les transformations les plus recommandées pour un usage général sont les transformations de "Chord" et "Hellinger" (Legendre et Legendre, 2012). Nous choisissons la transformation de Helliger qui obtient le meilleur R^2 (Legendre et Gallagher, 2001).

2- Transformer les abondances relatives en données de présence-absence (binaire)

Il est recommandé d'utiliser les données de présence-absence lorsque c'est la seule chose disponible ou lorsque nos variables quantitatives sont de qualité inégale ou incertaine (Borcard et al. 2011). Les associations biologiques peuvent être définies sur la base d'une co-occurence des espèces plutôt que sur la co-fluctuation des abondances (Legendre et Lengendre, 2012). Il faut encore une fois transformer les données à l'aide d'un coefficient binaire assymétrique. 

## Étape 8.0 Exécuter l'analyse 

A- On commence par transformer les matrices d'abondance. 

```{r hellinger_tranformation, message=FALSE}
library("vegan")
#library(adespatial)
# Faire une matrice de distance Hellinger

# Alternate, two-step computation in vegan: 
amphi.hel= dat%>% 
    subset(oxygene>0) %>% 
  # on enlève les sites avec l'oxygène à 0 ^^
  select(A_Gr:N_Vi) %>% 
  decostand("hellinger")

rownames(amphi.hel) <- subset(dat, oxygene>0)$etang
# On change le nom des lignes pour se retrouver plus tard ^^
head(amphi.hel)
```

## Étape 8.0 Exécuter l'analyse 
 
B- On standardize les covariables.

```{r standardize_covariables, results="hide"}
# Co-variables
topo=dat %>% 
    subset(oxygene>0) %>% 
  select(aire, profondeur) %>% 
  decostand("standardize")

rownames(topo) <- subset(dat, oxygene>0)$etang
# On change le nom des lignes pour se retrouver plus tard ^^
```
## Étape 8.0 Exécuter l'analyse 

C- Les variables.<br>Ici on a seulement standardisée les variables, mais on a aussi joint une RDA partielle réalisée avec des variables environnementales transformées avant d'être standardisées. 

```{r standardize_variables, results="hide"}
env=dat %>% 
  select( vache_std, 
          conductivite:temperature,
          invertebres:poissons) %>%
  select(-pH) %>% 
  subset(oxygene>0) %>% 
  decostand("standardize") 

env=cbind(subset(dat, oxygene>0)$cloture, 
          env) %>% 
  # on rattache la variable cloture, qui n'est pas standardisée (catégorique)^^
  rename(cloture= `subset(dat, oxygene > 0)$cloture`) # un nom qui a de l'allure.

rownames(env) <- subset(dat, oxygene>0)$etang
# On change le nom des lignes pour se retrouver plus tard ^^
```

## Étape 8.1 Exécuter l'analyse 
On lance la RDA partielle: 

```{r RDA_launched, message=FALSE}
require(vegan)
(prda=rda(amphi.hel~ . + Condition(topo$aire +topo$profondeur), env) )
```

## Étape 8.1 Exécuter l'analyse 

Donc, *avant* de valider si l'analyse a bien fonctionné, on peu voir dans le output de la RDA que près de 10% de la variance dans l'abondance est expliquée par les covariables, et environ 37% par les variables environnementales. <br> Par contre, ces pourcentages de variance expliqué sont biaisés. Effectivement,lorsqu'on utilise un R² ajusté, la variation expliquée par les variables environnementales tombent à :

```{r RDA_code, message=FALSE}
 (R2adj <- round(RsquareAdj(prda)$adj.r.squared, dig=3))
```
Plus modeste! Aussi, ça concorde un peu plus avec la comparaison des premières valeurs propres de la RDA et de la PCA sur la variation résiduelle, qui sont pas mal similaires. 

## Étape 8.2 Valider l'analyse 

Le test de permutations du modèle global nous indique que le modèle a quand même une certaine valeur, il permet d'expliquer une proportion de la variance dans les communautés d'abondances :
```{r RDA_check_model}
#source("panelutils.R")
anova(prda, permutations = how(nperm = 999))
```

## Étape 8.2 Valider l'analyse 

Le test de permutations sur les axes nous indique que seulement le premier axe de la RDA est *significatif*

```{r RDA_check_axis}
anova(prda, by="axis", permutations = how(nperm = 999))
```

## Étape 8.2 Valider l'analyse 
Le tests de permutations sur les variables explicatives montre que les variables clôture, nitrates, temperature et poissons semblent mieux expliquer la variance dans la matrice d'abondances des amphibiens. C'est aussi envisageable de réduire le nombre de variables dans la RDA dans de prochaines étapes. 

```{r RDA_checks_terms}
anova(prda, by="term", permutations = how(nperm = 999))
```

## Étape 8.2 Valider l'analyse 

Vérifier s'il y a de la collinéarité entre les variables explicatives:
```{r RDA_checks_vif}
vif.cca(prda)
```
Tout est bien. 

## Étape 8.3 Interpréter les résultats 

```{r RDA_triplots, message=F, warnings=F, echo=F}
source("triplot.rda.R")

par(mfrow=c(1,2))

triplot.rda(prda, scaling=1, 
            move.origin=c(0, 0), 
            mar.percent=0,
            silent=T)
# sc_si <- scores(prda, display="sites", choices=c(1,2), scaling=1)
# points(sc_si[c("48","90", "126", "150", "209"), ], 
#        pch = 21, # set shape (here, circle with a fill colour)
#        col = "black", # outline colour
#        bg = "steelblue", # fill colour
#        cex = 1.2) # size
triplot.rda(prda, scaling=2, 
            move.origin=c(0, 0), 
            mar.percent=0.05,
            silent=T)

#OR... draw two custom plots: ####
## extract % explained by the first 2 axes
perc <- round(100*(summary(prda)$cont$importance[2, 1:2]), 2)

## extract scores - these are coordinates in the RDA space
sc_si <- scores(prda, display="sites", choices=c(1,2), scaling=1)
sc_sp <- scores(prda, display="species", choices=c(1,2), scaling=1)
sc_bp <- scores(prda, display="bp", choices=c(1, 2), scaling=1)

## Custom triplot, step by step

# Set up a blank plot with scaling, axes, and labels
plot(prda,
     scaling = 1, # set scaling type 
     type = "none", # this excludes the plotting of any points from the results
     frame = T,
     # set axis limits
     # ylim = c(-0.6,0.5), 
     # xlim = c(-1,1),
     # label the plot (title, and axes)
     main = "Triplot RDA - scaling 1",
     xlab = paste0("RDA1 (", perc[1], "%)"), 
     ylab = paste0("RDA2 (", perc[2], "%)") , 
     bty="o"
)

# add points for site scores
points(sc_si, 
       pch = 21, # set shape (here, circle with a fill colour)
       col = "black", # outline colour
       bg = "pink", # fill colour
       cex = 1.2) # size

points(sc_si[c("48","90", "126", "150", "209"), ], 
       pch = 21, # set shape (here, circle with a fill colour)
       col = "black", # outline colour
       bg = "steelblue", # fill colour
       cex = 1.2) # size


# add points for species scores
points(sc_sp, 
       pch = 22, # set shape (here, square with a fill colour)
       col = "black",
       bg = "#f2bd33", 
       cex = 1.2)
# add text labels for species abbreviations
text(sc_sp + c(0.03, 0.09), # adjust text coordinates to avoid overlap with points 
     labels = rownames(sc_sp), 
     col = "grey40", 
     font = 2, # bold
     cex = 0.6)
# add arrows for effects of the expanatory variables
arrows(0,0, # start them from (0,0)
       sc_bp[,1], sc_bp[,2], # end them at the score value
       col = "red", 
       lwd = 3)
# add text labels for arrows
text(x = sc_bp[,1] -0.1, # adjust text coordinate to avoid overlap with arrow tip
     y = sc_bp[,2] - 0.03, 
     labels = rownames(sc_bp), 
     col = "red", 
     cex = 1, 
     font = 2)

```

## Variance partitionning
```{r}
# Explanation of fraction labels (two, three and four explanatory matrices) with optional colours)
#par(mfrow = c(1, 3), mar = c(1, 1, 1, 1))
# showvarparts(2, bg = c("red", "blue"))
# showvarparts(3, bg = c("red", "blue", "yellow")) 
# showvarparts(4, bg = c("red", "blue", "yellow", "green"))

## Variation partitioning with all explanatory variables
vache<-env[,1:2]
anim<-env[,7:9]
chem<-env[,3:6]
amphi.part.all <- varpart(amphi.hel, vache, chem, anim)
amphi.part.all
par(mfrow= c(1,1))
plot(amphi.part.all, digits = 3, bg = c("red", "blue", "yellow"), Xnames = c("Bétail", "Physico-chimie", "Communautés animales"))

cloture<-env[,1]
amphi.part <- varpart(amphi.hel, cloture, chem, anim)
amphi.part
plot(amphi.part, digits = 3, bg = c("red", "blue", "yellow"), Xnames = c("Clôture", "Physico-chimie", "Communautés animales")) #Étrangement, ça explique plus quand j'enlève vache_std

nitrates=env$nitrates
poiss=env$poissons
amphi.part.select <- varpart(amphi.hel, cloture, nitrates, anim)
amphi.part.select
par(mfrow= c(1,1))
plot(amphi.part.select, digits = 3, bg = c("red", "blue", "yellow"), Xnames = c("Clôtures", "Nitrates", "Communautés animales"))
amphi.part.4 <- varpart(amphi.hel, cloture, nitrates, poiss)
amphi.part.4
par(mfrow= c(1,1))
plot(amphi.part.select, digits = 3, bg = c("red", "blue", "yellow"), Xnames = c("Clôtures", "Nitrates", "Poissons"))

amphi.parsi <- varpart(amphi.hel, cloture, poiss)
amphi.parsi
par(mfrow= c(1,1))
plot(amphi.parsi, digits=2, bg = c("red", "blue"),Xnames = c("Clôtures",  "Poissons"))



```


## Matériel supplémentaire | Effet de quelques variables moins discipliniés

On a voulu vérifier la validité de valeurs plus élevées ou plus basses pour le pH et la température.  <br>
- Premièrement, les valeurs extrèmes de température ont lieu surtout dans les petits étangs peu profonds, donc ce ne sont probablement pas des erreurs de mesures.
- Deuxièmement, les valeurs de pH très élevées et très basses sont louches un peu. P. ex. même avec un pH de 1.88, des poissons ont été observés dans l'étang 155.


```{r extreme_values, eval=FALSE, results="hide", message=F, warnings=F, echo=F}
# Valeurs extrèmes dans les paramètres ####

# temperature
dat %>% 
  subset(temperature>30) %>% 
  select(etang, vache_std, cloture,
         conductivite:temperature,
         aire, profondeur)

dat %>% 
  subset(temperature>30) %>% 
  select(etang, temperature, invertebres:poissons) 

#Donc les valeurs de temperatures élevées sont dans les étangs les plus petits et moins profonds. Rassurant, et ce ne sont probablement pas des valeurs erronées.  Ces deux étangs ont aussi des valeurs de pH dans  le 1er quantile et des concentrations d'oxygène dans le 3e quantile.

# pH

dat %>% 
  subset(pH<4|pH>9) %>% 
  select(etang, vache_std, cloture,
         conductivite:temperature,
         aire, profondeur)

dat %>% 
  subset(pH<4|pH>9) %>% 
  select(etang, pH, invertebres:poissons) 
# Effectivement, dur de dire ce qu'il s'est passé, mais même avec un pH de 1.38, des poissons ont quand même été comptés dans l'étang  # 155!

```

Ensuite, on épargne le code un peu, pour des raisons visuelles, mais on a testé différentes transformation (plusieurs saveurs de log, et aussi la racine carré) sur la température, les poissons et les ecrevisses.  
- Visuellement, ce n'était pas très concluant. On a gardé la valeur de température sur son échelle originale. 
- Par contre, on a modélisé les poissons et écrevisses comme des valeurs binaires, question de vérifier si les conclusions varient beaucoup entre deux modèles globaux.  

```{r check_if_transformations_help, results="hide", message=F, warnings=F, echo=F, eval=F}
# Est-ce que les variables bénéficieraient d'une transformation ? ####

# la température, les poissons et les écrevisses ont beaucoup de 0. on pourrait vérifier l'effet de transformer la variable peut-être ?

par(mfrow=c(2,3))
dat$temperature %>% 
hist(main="temperature")
log(dat$temperature) %>% 
hist(main="ln(temperature)")

log(dat$temperature+0.001) %>% 
hist(main="ln(temperature+0.001)")
log(dat$temperature+0.01) %>% 
hist(main="ln(temperature+0.01)")
log(dat$temperature+0.1) %>% 
hist(main="ln(temperature+0.1)")
log(dat$temperature+1) %>% 
hist(main="ln(temperature+1)")

par(mfrow=c(1,1))

sqrt(dat$temperature) %>% 
hist(main="sqrt(temperature)")
 # temperature, pas évident, mais peu importe les transformations la distribution la plus belle est l'originale. 
# restons avec les valeurs originales.

# Poissons:
par(mfrow=c(2,3))

dat$poissons %>% 
hist(main="poissons")

log(dat$poissons+0.001) %>% 
hist(main="ln(poissons+0.001)")

log(dat$poissons+0.01) %>% 
hist(main="ln(poissons+0.01)")

log(dat$poissons+0.1) %>% 
hist(main="ln(poissons+0.1)")

log(dat$poissons+1) %>% 
hist(main="ln(poissons+1)")

par(mfrow=c(1,1))
sqrt(dat$poissons) %>% 
hist(main="sqrt(poissons)")

#Poissons, pas évident, il y a beaucoup de 0. Peu importe les transformations la distribution la plus belle est l'originale. 
# restons avec les valeurs originale, ou encore on peut créer une variable binaire. 

# ecrevisses:
par(mfrow=c(2,3))

dat$ecrevisses %>% 
hist(main="ecrevisses")

log(dat$ecrevisses+0.001) %>% 
hist(main="ln(ecrevisses+0.001)")

log(dat$ecrevisses+0.01) %>% 
hist(main="ln(ecrevisses+0.01)")

log(dat$ecrevisses+0.1) %>% 
hist(main="ln(ecrevisses+0.1)")

log(dat$ecrevisses+1) %>% 
hist(main="ln(ecrevisses+1)")

sqrt(dat$ecrevisses) %>% 
hist(main="sqrt(ecrevisses)")

 # ecrevisses, pas évident, il y a beaucoup de 0. Peu importe les transformations la distribution ne s'améliore pas beaucoup. restons avec les valeurs originale, ou encore on peut créer une variable binaire.
```

## Matériel supplémentaire | RDA avec variables binaires
```{r scnd_RDA_prepare_data, results="hide", message=F, warnings=F, echo=F}
topo=dat %>% 
    subset(oxygene>0) %>% 
  select(aire, profondeur) %>% 
  decostand("standardize")

rownames(topo) <- subset(dat, oxygene>0)$etang
# On change le nom des lignes pour se retrouver plus tard ^^
env2=dat %>% 
  select( vache_std, 
          conductivite:temperature,
          invertebres) %>%
  mutate(temperature2=as.numeric(ifelse(temperature >29.2, 30.2, temperature))) %>%
  select(-temperature)%>% 
  rename(temperature=temperature2) %>% 
  subset(oxygene>0) %>% 
  decostand("standardize") 

tmp=dat %>% 
  select(cloture, poissons, ecrevisses, oxygene) %>% 
    subset(oxygene>0) %>% 
  mutate(poiss_bin=case_when(poissons>0~ "Yes", 
                             T~"No"),
         ecre_bin=case_when(ecrevisses>0~"Yes", 
                         T~"No")) %>%  
  mutate_at(.vars=c("poiss_bin", "ecre_bin"), factor) %>% 
  select(-poissons, -ecrevisses, -oxygene) 
env2=cbind(tmp, 
          env2) 
rm(tmp)
  # on rattache les variables catégoriques ^^
rownames(env2) <- subset(dat, oxygene>0)$etang
# On change le nom des lignes pour se retrouver plus tard ^^
```
On lance la RDA partielle, avec des variables binaires poiur les poissons et les écrevisses. `env2` a été fait plus haut mais le code est caché. 

```{r scnd_RDA_launched, message=FALSE}
require(vegan)
(prda2=rda(amphi.hel ~ . + Condition(topo$aire +topo$profondeur), env2) )
```

```{r scnd_RDA_checks, eval=F, message=FALSE}
 (R2adj_2 <- round(RsquareAdj(prda2)$adj.r.squared, dig=3))

anova(prda2, permutations = how(nperm = 999))
anova(prda2, by="axis", permutations = how(nperm = 999))
anova(prda2, by="term", permutations = how(nperm = 999))
vif.cca(prda2)

source("triplot.rda.R")

par(mfrow=c(1,2))

triplot.rda(prda2, scaling=1, 
            move.origin=c(0, 0), 
            mar.percent=0.05,
            silent=T)
triplot.rda(prda2, scaling=2, 
            move.origin=c(0, 0), 
            mar.percent=0.05,
            silent=T)

```



